<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Grocery Tracker | متتبع البقالة بالذكاء الاصطناعي</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Keep all your existing CSS styles exactly as they are] */
        /* ... (paste all your current CSS here unchanged) ... */
    </style>
</head>
<body>
    <!-- [Keep all your existing HTML exactly as it is] -->
    <!-- ... (paste all your current HTML structure here unchanged) ... -->

    <script>
        // ====== APP STATE ======
        let groceries = JSON.parse(localStorage.getItem('groceries')) || [];
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let voiceHistory = JSON.parse(localStorage.getItem('voiceHistory')) || [];
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let currentLanguage = localStorage.getItem('language') || 'ar';
        let currentMonthFilter = 'current';

        // ====== DOM ELEMENTS ======
        const elements = {
            appTitle: document.getElementById('appTitle'),
            themeToggle: document.getElementById('themeToggle'),
            themeText: document.getElementById('themeText'),
            languageToggle: document.getElementById('languageToggle'),
            languageText: document.getElementById('languageText'),
            micButton: document.getElementById('micButton'),
            voiceButtonText: document.getElementById('voiceButtonText'),
            voiceStatus: document.getElementById('voiceStatus'),
            manualInput: document.getElementById('manualInput'),
            addButton: document.getElementById('addButton'),
            groceryTitle: document.getElementById('groceryTitle'),
            groceryList: document.getElementById('groceryList'),
            totalText: document.getElementById('totalText'),
            totalAmount: document.getElementById('totalAmount'),
            monthText: document.getElementById('monthText'),
            currency: document.getElementById('currency'),
            notesTitle: document.getElementById('notesTitle'),
            notesList: document.getElementById('notesList'),
            addNoteBtn: document.getElementById('addNoteBtn'),
            monthTitle: document.getElementById('monthTitle'),
            monthSelect: document.getElementById('monthSelect'),
            historyTitle: document.getElementById('historyTitle'),
            voiceHistory: document.getElementById('voiceHistory'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            clearHistoryText: document.getElementById('clearHistoryText')
        };

        // ====== VOICE RECOGNITION ======
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                elements.micButton.style.display = 'none';
                elements.voiceStatus.textContent = currentLanguage === 'ar' ? 
                    'التعرف الصوتي غير مدعوم في هذا المتصفح' : 
                    'Voice recognition not supported in this browser';
                return null;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = currentLanguage === 'ar' ? 'ar-SA' : 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 3;

            recognition.onstart = () => {
                elements.micButton.classList.add('listening');
                elements.voiceStatus.textContent = currentLanguage === 'ar' ? 
                    'يستمع الآن... تحدث بوضوح' : 
                    'Listening... Speak clearly';
            };

            recognition.onend = () => {
                elements.micButton.classList.remove('listening');
                elements.voiceStatus.textContent = currentLanguage === 'ar' ? 
                    'جاهز للتحدث' : 
                    'Ready to speak';
            };

            recognition.onresult = (event) => {
                const result = event.results[0][0];
                const text = result.transcript;
                const confidence = result.confidence;

                voiceHistory.unshift({
                    text: text,
                    language: currentLanguage,
                    timestamp: new Date().toISOString(),
                    confidence: confidence
                });
                localStorage.setItem('voiceHistory', JSON.stringify(voiceHistory));
                updateVoiceHistory();

                processVoiceCommand(text);
            };

            recognition.onerror = (event) => {
                const errorMessages = {
                    'ar': {
                        'no-speech': 'لم يتم الكشف عن صوت',
                        'default': 'خطأ في التعرف الصوتي'
                    },
                    'en': {
                        'no-speech': 'No speech detected',
                        'default': 'Voice recognition error'
                    }
                };
                elements.voiceStatus.textContent = errorMessages[currentLanguage][event.error] || errorMessages[currentLanguage]['default'];
            };

            return recognition;
        }

        const recognition = initVoiceRecognition();

        // ====== IMPROVED VOICE PROCESSING ======
        function processVoiceCommand(text) {
            elements.manualInput.value = text;
            
            // 1. PRICE DETECTION (EUROS + CENTS)
            const pricePattern = currentLanguage === 'ar' ? 
                /(\d+)[\s,]*(?:و)?[\s,]*(\d+)?\s*(يورو|ريال|دولار|جنيها?|ليرة?)/ :
                /(\d+)[\s,]*(?:and)?[\s,]*(\d+)?\s*(euros?|dollars?|pounds?|USD|EUR)/;
            
            const priceMatch = text.match(pricePattern);
            let price = 0;
            if (priceMatch) {
                const euros = parseFloat(priceMatch[1].replace(',', '.')) || 0;
                const cents = parseFloat(priceMatch[2]?.replace(',', '.')) || 0;
                price = euros + (cents / 100);
            }

            // 2. QUANTITY DETECTION
            const quantityPattern = currentLanguage === 'ar' ?
                /(\d+[,.]?\d*)\s*(كيلو|كجم|جرام|لتر|علبة|حبة|قطعة|كيس)/ :
                /(\d+[,.]?\d*)\s*(kg|kilo|grams?|liters?|bottles?|pieces?|bags?)/;
            
            const quantityMatch = text.match(quantityPattern);
            let quantity = "1";
            if (quantityMatch) {
                quantity = parseFloat(quantityMatch[1].replace(',', '.'));
                const unit = quantityMatch[2];
                
                // Standardize units
                if (currentLanguage === 'ar') {
                    if (unit === "كيلو" || unit === "كجم") quantity += " كجم";
                    else if (unit === "جرام") quantity += " جم";
                    else quantity += ` ${unit}`;
                } else {
                    if (unit === "kg" || unit === "kilo") quantity += " kg";
                    else if (unit.startsWith("gram")) quantity += " g";
                    else quantity += ` ${unit}`;
                }
            }

            // 3. ITEM NAME EXTRACTION
            let itemName = text
                .replace(pricePattern, '')
                .replace(quantityPattern, '')
                .replace(/[0-9,.]+/, '')
                .trim();
            
            if (itemName === '') {
                itemName = currentLanguage === 'ar' ? 'صنف غير معروف' : 'Unknown item';
            }

            // 4. ADD TO LIST
            addGroceryItem(itemName, quantity, price);
        }

        // ====== GROCERY LIST FUNCTIONS ======
        function addGroceryItem(name, quantity, price) {
            const newItem = {
                id: Date.now(),
                name: name,
                quantity: quantity,
                price: price,
                date: new Date().toISOString(),
                language: currentLanguage
            };
            
            groceries.unshift(newItem);
            saveGroceries();
            updateGroceryList();
            elements.manualInput.value = '';
            
            const btn = elements.addButton;
            btn.innerHTML = currentLanguage === 'ar' ? 
                '<i class="fas fa-check"></i> تمت الإضافة' : 
                '<i class="fas fa-check"></i> Added';
            btn.classList.add('btn-secondary');
            setTimeout(() => {
                btn.innerHTML = currentLanguage === 'ar' ? 'إضافة' : 'Add';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            }, 1500);
        }

        function saveGroceries() {
            localStorage.setItem('groceries', JSON.stringify(groceries));
            updateTotal();
            populateMonthSelector();
        }

        function updateGroceryList() {
            elements.groceryList.innerHTML = '';
            
            let filteredItems = currentMonthFilter === 'current' ? 
                groceries.filter(item => {
                    const itemDate = new Date(item.date);
                    return `${itemDate.getFullYear()}-${itemDate.getMonth()}` === getCurrentMonthYear();
                }) : 
                groceries.filter(item => {
                    const itemDate = new Date(item.date);
                    return `${itemDate.getFullYear()}-${itemDate.getMonth()}` === currentMonthFilter;
                });
            
            if (filteredItems.length === 0) {
                const emptyMsg = currentLanguage === 'ar' ? 
                    'لا توجد عناصر في القائمة لهذا الشهر' : 
                    'No items in the list for this month';
                const emptyEl = document.createElement('li');
                emptyEl.className = 'empty-state';
                emptyEl.textContent = emptyMsg;
                elements.groceryList.appendChild(emptyEl);
                return;
            }
            
            filteredItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'grocery-item fade-in';
                
                const itemDate = new Date(item.date);
                const dateStr = itemDate.toLocaleDateString(
                    currentLanguage === 'ar' ? 'ar-EG' : 'en-US',
                    { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }
                );
                
                li.innerHTML = `
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-quantity">${item.quantity}</div>
                        <div class="item-price">${item.price.toFixed(2)} ${currentLanguage === 'ar' ? 'يورو' : 'EUR'}</div>
                        <div class="item-date">${dateStr}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-outline btn-sm btn-icon" onclick="editGroceryItem(${item.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm btn-icon" onclick="deleteGroceryItem(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                elements.groceryList.appendChild(li);
            });
            
            updateTotal();
        }

        // ====== REST OF THE FUNCTIONS ======
        // [Keep all your other existing functions exactly as they are]
        // ... (updateGroceryList, updateTotal, deleteGroceryItem, editGroceryItem, etc.) ...

        // ====== INITIALIZE APP ======
        function initApp() {
            setTheme(isDarkMode);
            setLanguage(currentLanguage);
            initVoiceRecognition();
            
            updateGroceryList();
            updateNotesList();
            updateVoiceHistory();
            populateMonthSelector();
            
            setupEventListeners();
        }

        document.addEventListener('DOMContentLoaded', initApp);

        // ====== GLOBAL FUNCTIONS ======
        window.deleteGroceryItem = deleteGroceryItem;
        window.editGroceryItem = editGroceryItem;
        window.deleteNote = deleteNote;
        window.deleteHistoryItem = deleteHistoryItem;
    </script>
</body>
</html>
